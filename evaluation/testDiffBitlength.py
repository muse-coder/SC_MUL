from SC_MUL.components import *
import pandas as pd
import statistics
import os
import timeit

import math
def generate_df(sobolGroups ,mredGroup ,sobolWidth ,savingPath):
    dfIndex=[]
    dfMred=[]
    dfSobolWidth=[]

    
    for i in range(len(sobolGroups)):
        dfIndex.append(("sobolGroup_"+str(i)))
        mred = "%.4lf"%(mredGroup[i]*100)+"%"
        dfMred.append(mred)
        dfSobolWidth.append(sobolWidth)
        # df
    averageMRED = statistics.mean(mredGroup)
    average =  "%.4lf"%(averageMRED*100)+"%"
    dfIndex.append("averageMRED")
    dfMred.append(average)
    dfSobolWidth.append(sobolWidth)

    data={"MRED:":dfMred,"sobolWidth":dfSobolWidth}
    df=pd.DataFrame(data,index=dfIndex)
    df.to_csv(savingPath)
    return df
    

if __name__=="__main__":
    sobol_8_1 = [0,4,6,2,3,7,5,1]
    sobol_8_2 = [0,4,2,6,3,7,1,5]

    sobol_16_1 = [0,8,12,4,6,14,10,2,3,11,15,7,5,13,9,1]
    sobol_16_2 = [0,8,4,12,6,14,2,10,5,13,1,9,3,11,7,15]
    # sobol_3 = [0,8,4,12,10,2,14,6,15,7,11,3,5,13,1,9]
    # sobol_4 = [0,8,4,12,14,6,10,2,7,15,3,11,9,1,13,5]
    sobol_32_1=[0,16,24,8,12,28,20,4,6,22,30,14,10,26,18,2,3,19,27,11,15,31,23,7,5,21,29,13,9,25,17,1]
    sobol_32_2=[0,16,8,24,12,28,4,20,10,26,2,18,6,22,14,30,15,31,7,23,3,19,11,27,5,21,13,29,9,25,1,17]
    # sobol_3=[0,16,8,24,20,4,28,12,30,14,22,6,10,26,2,18,15,31,7,23,27,11,19,3,17,1,25,9,5,21,13,29]
    # sobol_4=[0,16,8,24,28,12,20,4,14,30,6,22,18,2,26,10,21,5,29,13,9,25,1,17,27,11,19,3,7,23,15,31]
    sobol_64_1 =  [0,32,48,16,24,56,40,8,12,44,60,28,20,52,36,4,6,38,54,22,30,62,46,14,10,42,58,26,18,50,34,2,3,35,51,19,27,59,43,11,15,47,63,31,23,55,39,7,5,37,53,21,29,61,45,13,9,41,57,25,17,49,33,1]
    sobol_64_2 =  [0,32,16,48,24,56,8,40,20,52,4,36,12,44,28,60,30,62,14,46,6,38,22,54,10,42,26,58,18,50,2,34,17,49,1,33,9,41,25,57,5,37,21,53,29,61,13,45,15,47,31,63,23,55,7,39,27,59,11,43,3,35,19,51]
    # sobol_3 =  [0,32,16,48,40,8,56,24,60,28,44,12,20,52,4,36,30,62,14,46,54,22,38,6,34,2,50,18,10,42,26,58,45,13,61,29,5,37,21,53,17,49,1,33,57,25,41,9,51,19,35,3,27,59,11,43,15,47,31,63,39,7,55,23]
    # sobol_4 =  [0,32,16,48,56,24,40,8,28,60,12,44,36,4,52,20,42,10,58,26,18,50,2,34,54,22,38,6,14,46,30,62,35,3,51,19,27,59,11,43,63,31,47,15,7,39,23,55,9,41,25,57,49,17,33,1,21,53,5,37,45,13,61,29]

    sobol_128_1 =  [0,64,96,32,48,112,80,16,24,88,120,56,40,104,72,8,12,76,108,44,60,124,92,28,20,84
                ,116,52,36,100,68,4,6,70,102,38,54,118,86,22,30,94,126,62,46,110,78,14,10,74,106
                ,42,58,122,90,26,18,82,114,50,34,98,66,2,3,67,99,35,51,115,83,19,27,91,123,59,43
                ,107,75,11,15,79,111,47,63,127,95,31,23,87,119,55,39,103,71,7,5,69,101,37,53,117
                ,85,21,29,93,125,61,45,109,77,13,9,73,105,41,57,121,89,25,17,81,113,49,33,97,65,1]


    sobol_128_2= [0,64,32,96,48,112,16,80,40,104,8,72,24,88,56,120,60,124,28,92,12,76,44,108,20,84,52
            ,116,36,100,4,68,34,98,2,66,18,82,50,114,10,74,42,106,58,122,26,90,30,94,62,126,46
            ,110,14,78,54,118,22,86,6,70,38,102,51,115,19,83,3,67,35,99,27,91,59,123,43,107,11
            ,75,15,79,47,111,63,127,31,95,39,103,7,71,23,87,55,119,17,81,49,113,33,97,1,65,57
            ,121,25,89,9,73,41,105,45,109,13,77,29,93,61,125,5,69,37,101,53,117,21,85]

    sobol_256_1 = [0,128,192,64,96,224,160,32,48,176,240,112,80,208,144,16,24,152,216,88,120,248,184,56,40,168,232,104,72,200,136,8,12,140,204,76,108,236,172,44,60,188,252,124,92,220,156,28,20,148,212,84,116,244,180,52,36,164,228,100,68,196,132,4,6,134,198,70,102,230,166,38,54,182,246,118,86,214,150,22,30,158,222,94,126,254,190,62,46,174,238,110,78,206,142,14,10,138,202,74,106,234,170,42,58,186,250,122,90,218,154,26,18,146,210,82,114,242,178,50,34,162,226,98,66,194,130,2,3,131,195,67,99,227,163,35,51,179,243,115,83,211,147,19,27,155,219,91,123,251,187,59,43,171,235,107,75,203,139,11,15,143,207,79,111,239,175,47,63,191,255,127,95,223,159,31,23,151,215,87,119,247,183,55,39,167,231,103,71,199,135,7,5,133,197,69,101,229,165,37,53,181,245,117,85,213,149,21,29,157,221,93,125,253,189,61,45,173,237,109,77,205,141,13,9,137,201,73,105,233,169,41,57,185,249,121,89,217,153,25,17,145,209,81,113,241,177,49,33,161,225,97,65,193,129,1]

    sobol_256_2 = [0,128,64,192,96,224,32,160,80,208,16,144,48,176,112,240,120,248,56,184,24,152,88,216,40,168,104,232,72,200,8,136,68,196,4,132,36,164,100,228,20,148,84,212,116,244,52,180,60,188,124,252,92,220,28,156,108,236,44,172,12,140,76,204,102,230,38,166,6,134,70,198,54,182,118,246,86,214,22,150,30,158,94,222,126,254,62,190,78,206,14,142,46,174,110,238,34,162,98,226,66,194,2,130,114,242,50,178,18,146,82,210,90,218,26,154,58,186,122,250,10,138,74,202,106,234,42,170,85,213,21,149,53,181,117,245,5,133,69,197,101,229,37,165,45,173,109,237,77,205,13,141,125,253,61,189,29,157,93,221,17,145,81,209,113,241,49,177,65,193,1,129,33,161,97,225,105,233,41,169,9,137,73,201,57,185,121,249,89,217,25,153,51,179,115,243,83,211,19,147,99,227,35,163,3,131,67,195,75,203,11,139,43,171,107,235,27,155,91,219,123,251,59,187,119,247,55,183,23,151,87,215,39,167,103,231,71,199,7,135,15,143,79,207,111,239,47,175,95,223,31,159,63,191,127,255] 

    sobol_512_1 =  [0,256,384,128,192,448,320,64,96,352,480,224,160,416,288,32,48,304,432,176,240,496,368,112,80,336,464,208,144,400,272,16,24,280,408,152,216,472,344,88,120,376,504,248,184,440,312,56,40,296,424,168,232,488,360,104,72,328,456,200,136,392,264,8,12,268,396,140,204,460,332,76,108,364,492,236,172,428,300,44,60,316,444,188,252,508,380,124,92,348,476,220,156,412,284,28,20,276,404,148,212,468,340,84,116,372,500,244,180,436,308,52,36,292,420,164,228,484,356,100,68,324,452,196,132,388,260,4,6,262,390,134,198,454,326,70,102,358,486,230,166,422,294,38,54,310,438,182,246,502,374,118,86,342,470,214,150,406,278,22,30,286,414,158,222,478,350,94,126,382,510,254,190,446,318,62,46,302,430,174,238,494,366,110,78,334,462,206,142,398,270,14,10,266,394,138,202,458,330,74,106,362,490,234,170,426,298,42,58,314,442,186,250,506,378,122,90,346,474,218,154,410,282,26,18,274,402,146,210,466,338,82,114,370,498,242,178,434,306,50,34,290,418,162,226,482,354,98,66,322,450,194,130,386,258,2,3,259,387,131,195,451,323,67,99,355,483,227,163,419,291,35,51,307,435,179,243,499,371,115,83,339,467,211,147,403,275,19,27,283,411,155,219,475,347,91,123,379,507,251,187,443,315,59,43,299,427,171,235,491,363,107,75,331,459,203,139,395,267,11,15,271,399,143,207,463,335,79,111,367,495,239,175,431,303,47,63,319,447,191,255,511,383,127,95,351,479,223,159,415,287,31,23,279,407,151,215,471,343,87,119,375,503,247,183,439,311,55,39,295,423,167,231,487,359,103,71,327,455,199,135,391,263,7,5,261,389,133,197,453,325,69,101,357,485,229,165,421,293,37,53,309,437,181,245,501,373,117,85,341,469,213,149,405,277,21,29,285,413,157,221,477,349,93,125,381,509,253,189,445,317,61,45,301,429,173,237,493,365,109,77,333,461,205,141,397,269,13,9,265,393,137,201,457,329,73,105,361,489,233,169,425,297,41,57,313,441,185,249,505,377,121,89,345,473,217,153,409,281,25,17,273,401,145,209,465,337,81,113,369,497,241,177,433,305,49,33,289,417,161,225,481,353,97,65,321,449,193,129,385,257,1]
    sobol_512_2 =  [0,256,128,384,192,448,64,320,160,416,32,288,96,352,224,480,240,496,112,368,48,304,176,432,80,336,208,464,144,400,16,272,136,392,8,264,72,328,200,456,40,296,168,424,232,488,104,360,120,376,248,504,184,440,56,312,216,472,88,344,24,280,152,408,204,460,76,332,12,268,140,396,108,364,236,492,172,428,44,300,60,316,188,444,252,508,124,380,156,412,28,284,92,348,220,476,68,324,196,452,132,388,4,260,228,484,100,356,36,292,164,420,180,436,52,308,116,372,244,500,20,276,148,404,212,468,84,340,170,426,42,298,106,362,234,490,10,266,138,394,202,458,74,330,90,346,218,474,154,410,26,282,250,506,122,378,58,314,186,442,34,290,162,418,226,482,98,354,130,386,2,258,66,322,194,450,210,466,82,338,18,274,146,402,114,370,242,498,178,434,50,306,102,358,230,486,166,422,38,294,198,454,70,326,6,262,134,390,150,406,22,278,86,342,214,470,54,310,182,438,246,502,118,374,238,494,110,366,46,302,174,430,78,334,206,462,142,398,14,270,30,286,158,414,222,478,94,350,190,446,62,318,126,382,254,510,255,511,127,383,63,319,191,447,95,351,223,479,159,415,31,287,15,271,143,399,207,463,79,335,175,431,47,303,111,367,239,495,119,375,247,503,183,439,55,311,215,471,87,343,23,279,151,407,135,391,7,263,71,327,199,455,39,295,167,423,231,487,103,359,51,307,179,435,243,499,115,371,147,403,19,275,83,339,211,467,195,451,67,323,3,259,131,387,99,355,227,483,163,419,35,291,187,443,59,315,123,379,251,507,27,283,155,411,219,475,91,347,75,331,203,459,139,395,11,267,235,491,107,363,43,299,171,427,85,341,213,469,149,405,21,277,245,501,117,373,53,309,181,437,165,421,37,293,101,357,229,485,5,261,133,389,197,453,69,325,221,477,93,349,29,285,157,413,125,381,253,509,189,445,61,317,45,301,173,429,237,493,109,365,141,397,13,269,77,333,205,461,153,409,25,281,89,345,217,473,57,313,185,441,249,505,121,377,105,361,233,489,169,425,41,297,201,457,73,329,9,265,137,393,17,273,145,401,209,465,81,337,177,433,49,305,113,369,241,497,225,481,97,353,33,289,161,417,65,321,193,449,129,385,1,257]

#########################################################                       
    dataWidth = 16                                  ###        
    # sobolWidth = int(math.log(len(sobol_1),2))        ###       
    validSegWidth = dataWidth                      ###
    # validSegWidth = 16                              ###
    # dataRange=(1,pow(2,dataWidth))                           ###
    # dataRange=(pow(2,dataWidth)/2,pow(2,dataWidth))                           ###
    # dataRange=(int(pow(2,dataWidth)/4),int(pow(2,dataWidth)/4)*2)                           ###
    # dataRange=(1,int(pow(2,dataWidth)/4))                           ###

    dataRange=(int(pow(2,dataWidth)/4)*2,int(pow(2,dataWidth)/4)*3)                           ###
    iterationRange=int(pow(2,dataWidth))*10                       ###

#########################################################

    workingPath = os.getcwd()
    
    savingPath=workingPath+'/evaluation/result'
    if not (os.path.exists(savingPath)):
        # savingPath=workingPath+'/result'
        os.mkdir(savingPath)
    
    savingPath = savingPath +'/testDiffSobol'
    if not (os.path.exists(savingPath)):
        os.mkdir(savingPath)
        
    savingPath = savingPath +'/dataRange_1_to_'+str(dataRange[1])
    if not (os.path.exists(savingPath)):
        os.mkdir(savingPath)

    resultName = "sobol_%d_SegWidth_%d.csv"%(pow(2,4),validSegWidth)
    savingPath = savingPath + '/'+ resultName
    group_1=[sobol_8_1,sobol_8_2]
    group_2=[sobol_16_1,sobol_16_2]
    group_3=[sobol_32_1,sobol_32_2]
    group_4=[sobol_64_1,sobol_64_2]
    group_5=[sobol_128_1,sobol_128_2]
    group_6=[sobol_256_1,sobol_256_2]
    group_7=[sobol_512_1,sobol_512_2]
    sobolGroups=[group_1,group_2,group_3,group_4,group_5,group_6 , group_7]
    # sobolGroups=[group_6,group_5,group_4,group_3,group_2,group_1]
    # sobolGroups=[group_1]
    # sobolGroups=[group_1,group_2,group_3]

    
    # writer = pd.ExcelWriter('test.xlsx')
    
    mredGroup = []
    mredGroup_2 = []
    for i in range (len(sobolGroups)):
        mredGroup.append(0)
        mredGroup_2.append(0)
    # iterationRange = 5000
    start_time = timeit.default_timer()
    for test in range(iterationRange):
        num_1=random.randint(dataRange[0],dataRange[1])
        num_2=random.randint(dataRange[0],dataRange[1])
        exact_res=num_1*num_2
        # print("num1 = %d, num2 = %d,error = "%(num_1,num_2),end='')
        # print("num1=%d,num2=%d,exact_res=%d"%(num_1,num_2,exact_res))
        for i in range(len(sobolGroups)):
            # sobolWidth = len(sobolGroups[i][0])
            sobolWidth = int(math.log(len(sobolGroups[i][0]),2))
            isc_res=scaled_mul(
                num_1=num_1,num_2=num_2,
                sobol_1= sobolGroups[i][0],sobol_2= sobolGroups[i][1],validSegWidth=validSegWidth,
                sobolWidth= sobolWidth,dataWidth=  dataWidth
            )
            ED_1 = abs(exact_res-isc_res)
            error= ED_1/exact_res
            # if error >=1: 
                # error = 1
            # error= ED/max(exact_res,isc_res)
            error2 = ED_1/65536/65536
            mredGroup[i] =(mredGroup[i]*(test)+error)/(test+1)
            mredGroup_2[i] =(mredGroup_2[i]*(test)+error2)/(test+1)
            # print(isc_res,error, end=' ')
        # print('\n')

    # mredGroup = [mredGroup [i] /iterationRange for i in range(len(mredGroup))]
    end_time = timeit.default_timer()
    print ("cost time :"+str(end_time - start_time)+"seconds")
    for i in range(len(mredGroup)):
        
        print("MRED %d = %.4lf"%(i+1,mredGroup[i]*100)+"% ",end=' ')
        print("  MED %d = %.8f"%(i+1,mredGroup_2[i]))
    # return mredGroup ,averageMRED
